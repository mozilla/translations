# This Source Code Form is subject to the terms of the Mozilla Public
# License, v. 2.0. If a copy of the MPL was not distributed with this
# file, You can obtain one at http://mozilla.org/MPL/2.0/.
---

loader: taskgraph.loader.transform:loader

transforms:
  - translations_taskgraph.transforms.worker_selection
  - taskgraph.transforms.task_context
  - taskgraph.transforms.run
  - taskgraph.transforms.task

kind-dependencies: []

tasks:
  all:
    description: >
      Updates SQLite database which is stored on GCS to be consumed by web apps
    attributes:
      stage: update-db

    task-context:
      substitution-fields:
        - attributes
        - run.command
    # todo: replace to []
    run-on-tasks-for: ["github-pull-request"]
    worker-type: b-cpu
    worker:
      chain-of-trust: true
      docker-image: {in-tree: toolchain-build}
      max-run-time: 86400
      volumes:
        - /builds/worker/artifacts
      artifacts:
        - name: public/build
          path: /builds/worker/artifacts
          type: volume
      # 128 happens when cloning this repository fails
      retry-exit-status: [128]

    run:
      using: run-task
      use-caches: [checkout, pip]
      command:
        - bash
        - -c
        - >-
          pip3 install -r $VCS_PATH/db/requirements/requirements.txt &&
          export PYTHONPATH=$PYTHONPATH:$VCS_PATH &&
          python3 $VCS_PATH/db/updater.py --db-path $TASK_WORKDIR/artifacts/db.sqlite
