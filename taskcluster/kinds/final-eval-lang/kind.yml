# This Source Code Form is subject to the terms of the Mozilla Public
# License, v. 2.0. If a copy of the MPL was not distributed with this
# file, You can obtain one at http://mozilla.org/MPL/2.0/.
---

loader: taskgraph.loader.transform:loader

transforms:
  - translations_taskgraph.transforms.worker_selection
  - taskgraph.transforms.task_context
  - taskgraph.transforms.run:transforms
  - translations_taskgraph.transforms.cached_tasks:transforms
  - taskgraph.transforms.task:transforms

kind-dependencies:
  - toolchain
  - compile
  - export
  # wait until the exported model is uploaded to GCS
  - upload-artifacts

tasks:
  "{src_locale}-{trg_locale}":
    description: >
      Run final evaluations for the langauge pair trained in the pipeline.
    attributes:
      stage: final-eval-lang
      src_locale: "{src_locale}"
      trg_locale: "{trg_locale}"
      cache:
        type: final-eval-lang
        resources:
          - pipeline/eval/final_eval.py
          - pipeline/eval/metrics.py
          - pipeline/eval/metricx.py
          - pipeline/eval/translators.py
          - pipeline/eval/metric_worker.py
          - pipeline/langs/codes.py
          - pipeline/langs/maps.py
          - pipeline/langs/scripts.py
          - pipeline/eval/eval_datasets.py
          - pipeline/eval/requirements/metricx.txt

    task-context:
      from-parameters:
          src_locale: training_config.experiment.src
          trg_locale: training_config.experiment.trg
          experiment: training_config.experiment.name
      substitution-fields:
        - description
        - name
        - fetches
        - dependencies
        - worker.env
        - attributes
        - run.command

    scopes:
      - secrets:get:project/translations/level-1/chatgpt
      - secrets:get:project/translations/level-1/huggingface
      - secrets:get:project/translations/level-1/azure-translate
      - secrets:get:project/translations/level-1/google-translate

    run-on-tasks-for: []
    worker-type: b-gpu
    worker:
      chain-of-trust: true
      docker-image: {"in-tree": "eval"}
      max-run-time: 86400
      env:
        WANDB_PUBLICATION: "false"
        # for metricx
        PROTOCOL_BUFFERS_PYTHON_IMPLEMENTATION: "python"
      volumes:
        - /builds/worker/artifacts
      artifacts:
        - name: public/build
          path: /builds/worker/artifacts
          type: volume
      # 128 happens when cloning this repository fails
      retry-exit-status: [128]

    run:
      using: run-task
      use-caches: [checkout, pip]
      command:
        - bash
        - -c
        - >-
          export PYTHONPATH=$PYTHONPATH:$VCS_PATH &&
          chmod +x $MOZ_FETCHES_DIR/translator-cli &&
          CI_ARGS=$( [ "{experiment}" == "ci" ] && echo "--config $VCS_PATH/taskcluster/configs/eval.ci.yml" || echo "" ) &&
          python3 $VCS_PATH/pipeline/eval/final_eval.py --languages {src_locale}-{trg_locale} --artifacts $TASK_WORKDIR/artifacts --bergamot-cli $MOZ_FETCHES_DIR/translator-cli $CI_ARGS

    dependencies:
        compile: compile-marian-fork
        upload: upload-artifacts-export-{src_locale}-{trg_locale}
    fetches:
        compile:
            - artifact: "translator-cli"
              extract: false
        toolchain:
            - cuda-toolkit
